@using MonopolyGame.Interface.Controles;
@using MonopolyPaperMario.Components.Stores
@inject IJSRuntime JSRuntime

@namespace MonopolyPaperMario.Components.Game.PlayerUI


<div class="player-ui w-25 d-flex flex-column align-items-center justify-content-center gap-2">
    <div class="previous-plays container d-flex flex-column align-items-center">
        <h1 class="text-center">HISTÓRICO DE JOGADAS</h1>

        <div @ref="_historicoElement" class="previous-plays-content overflow-auto w-100 container d-flex flex-column justify-content-start">
            @foreach (string registro in ControlePartida.Partida.Historico.Registros)
            {
                <span class="m-0">> @registro</span>
            }
        </div>
    </div>
    <div class="player-turn-counter">
        <h1>VEZ DO JOGADOR @(CurrentPlayer + 1): @(ControlePartida.Partida.JogadorAtual.Nome)</h1>
    </div>

    <div class="player-bar">
        @for (int i = 0; i < ControlePartida.Partida.Jogadores.Count; i++)
        {
            <div class="player-bar-character
                @(CurrentPlayer == i ? "bar-current-player" : "")
                @(ControlePartida.Partida.Jogadores[i].Falido ? "falido" : "")">
                <img src="@SpriteStore.GetSpritePathByPlayerId(i)" />
            </div>
        }
    </div>

    <div class="current-player">
        <img src="@SpriteStore.GetSpritePathByPlayerId(CurrentPlayer)"/>
        <div class="current-player-offset"></div>
        <div class="current-player-ui container d-flex flex-column justify-content-center">
            <div class="row m-1 mt-3">
                <h1 class="col-8 p-0">Dinheiro:</h1>
                <h1 class="col-4 p-0 text-md-end @(ControlePartida.Partida.JogadorAtual.Dinheiro < 0 ? "text-danger" : "")">@(ControlePartida.Partida.JogadorAtual.Dinheiro)★</h1>
            </div>
            @* <div class="row m-1">
                @if (DiceRolled) {
                    <button class="btn btn-primary col-8"
                            @onclick="() => MockPassarAVez()">
                        Passar a Vez
                    </button>

                    <div class="col-4 d-flex pe-0 justify-content-around">
                        <img class="dice" src="@iconStore.GetIconPath(IconId.Dice0 + Dice1)" />
                        <img class="dice" src="@iconStore.GetIconPath(IconId.Dice0 + Dice2)" />
                    </div>
                } else {
                    <button class="btn btn-primary"
                            @onclick="() => MockRolarDados()">
                        Rolar Dados
                    </button>
                }
            </div> *@
        </div>
    </div>
</div>

<script>
    function scrollToBottom(element) {
      if (element) {
        element.scrollTop = element.scrollHeight;
      }
    }
</script>

@code {
    private ElementReference _historicoElement;

    private ControlePartidaStore ControlePartidaStore = ControlePartidaStore.GetInstance();
    private IControlePartida ControlePartida { get => ControlePartidaStore.ControlePartida; }
    private CharacterSpriteStore SpriteStore = CharacterSpriteStore.GetInstance();
    private IconStore iconStore = IconStore.GetInstance();

    private Random random = new Random(); // remover depois

    public int CurrentPlayer { get => ControlePartida.Partida.JogadorAtualIndex; }

    protected override void OnInitialized()
    {
        ControlePartidaStore.OnStateChanged += StateHasChanged;
    }

    private int _previousRegistrosCount = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        int currentRegistrosCount = ControlePartida.Partida.Historico.Registros.Count;

        if (currentRegistrosCount > _previousRegistrosCount)
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", _historicoElement);
            
            _previousRegistrosCount = currentRegistrosCount;
        }
        else if (currentRegistrosCount < _previousRegistrosCount)
        {
            _previousRegistrosCount = currentRegistrosCount;
        }
    }
}
