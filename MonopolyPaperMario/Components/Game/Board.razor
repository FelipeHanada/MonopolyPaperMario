@using MonopolyGame.Interface.Controles
@using MonopolyGame.Model.Tabuleiros
@using MonopolyGame.Model.PossesJogador
@using MonopolyPaperMario.Components.Stores

@namespace MonopolyPaperMario.Components.Game.Board


<div class="board">
    <div class="board-center">
        <PlayerActions />
        @* <button @onclick="() => MovePlayer(0, 3)">Move Player 0 (3 steps)</button>
        <button @onclick="() => MovePlayer(5, 2)">Move Player 5 (2 steps)</button> *@
    </div>

    <div class="street" id="street-1">
        @for (int tileIndex = 1; tileIndex < 10; tileIndex++)
        {
            StreetTileData tile = GetStreetTileData(tileIndex);
            <div @onclick="() => HandleMouseClickTile(tile)" class="tile-wrapper @(tile.MousePointer ? "pointer" : "")">
                <Tile DisplayCharacters="GetCharactersOnTile(tileIndex)">
                    <StreetTile Title="@tile.Title"
                                Color="@tile.Color"
                                Cost="@tile.Cost"
                                HousingLevel="@tile.HousingLevel">
                        @if (!string.IsNullOrEmpty(tile.IconPath))
                        {
                            <img class="street-tile-icon" src="@tile.IconPath" />
                        }
                    </StreetTile>
                </Tile>
            </div>
        }
    </div>

    <div class="corner" id="corner-1-2">
        <Tile DisplayCharacters="GetCharactersOnTile(10)">
        </Tile>
    </div>

    <div class="street" id="street-2">
        @for (int tileIndex = 11; tileIndex < 20; tileIndex++)
        {
            StreetTileData tile = GetStreetTileData(tileIndex);
            <div @onclick="() => HandleMouseClickTile(tile)" class="tile-wrapper @(tile.MousePointer ? "pointer" : "")">
                <Tile DisplayCharacters="GetCharactersOnTile(tileIndex)">
                    <StreetTile Rotation="3"
                                Title="@tile.Title"
                                Color="@tile.Color"
                                Cost="@tile.Cost"
                                HousingLevel="@tile.HousingLevel">
                        @if (!string.IsNullOrEmpty(tile.IconPath))
                        {
                            <img class="street-tile-icon" src="@tile.IconPath" />
                        }
                    </StreetTile>
                </Tile>
            </div>
        }
    </div>

    <div class="corner" id="corner-2-3">
        <Tile DisplayCharacters="GetCharactersOnTile(20)">
        </Tile>
    </div>

    <div class="street" id="street-3">
        @for (int tileIndex = 21; tileIndex < 30; tileIndex++)
        {
            StreetTileData tile = GetStreetTileData(tileIndex);
            <div @onclick="() => HandleMouseClickTile(tile)" class="tile-wrapper @(tile.MousePointer ? "pointer" : "")">
                <Tile DisplayCharacters="GetCharactersOnTile(tileIndex)">
                    <StreetTile Rotation="2"
                                Title="@tile.Title"
                                Color="@tile.Color"
                                Cost="@tile.Cost"
                                HousingLevel="@tile.HousingLevel">
                        @if (!string.IsNullOrEmpty(tile.IconPath))
                        {
                            <img class="street-tile-icon" src="@tile.IconPath" />
                        }
                    </StreetTile>
                </Tile>
            </div>
        }
    </div>

    <div class="corner" id="corner-3-4">
        <Tile DisplayCharacters="GetCharactersOnTile(30)">
        </Tile>
    </div>

    <div class="street" id="street-4">
        @for (int tileIndex = 31; tileIndex < 40; tileIndex++)
        {
            StreetTileData tile = GetStreetTileData(tileIndex);
            <div @onclick="() => HandleMouseClickTile(tile)" class="tile-wrapper @(tile.MousePointer ? "pointer" : "")">
                <Tile DisplayCharacters="GetCharactersOnTile(tileIndex)">
                    <StreetTile Rotation="1"
                    Title="@tile.Title"
                    Color="@tile.Color"
                    Cost="@tile.Cost"
                    HousingLevel="@tile.HousingLevel">
                        @if (!string.IsNullOrEmpty(tile.IconPath))
                        {
                            <img class="street-tile-icon" src="@tile.IconPath" />
                        }
                    </StreetTile>
                </Tile>
            </div>
        }
    </div>

    <div class="corner" id="corner-4-1">
        <Tile DisplayCharacters="GetCharactersOnTile(0)">
        </Tile>
    </div>
</div>


@code {
    private IControlePartida controlePartida = ControlePartidaStore.ControlePartida;
    private CardVisualizerStore cardVisualizerStore = CardVisualizerStore.Instance;


    protected override void OnInitialized()
    {
        ControlePartidaStore.OnStateChanged += StateHasChanged;
    }

    private bool[] GetCharactersOnTile(int tileIndex)
    {
        var display = new bool[6];

        for (int i = 0; i < display.Length; i++)
        {
            if (i < controlePartida.Partida.Jogadores.Count && controlePartida.Partida.Tabuleiro.GetPosicao(controlePartida.Partida.Jogadores[i]) == tileIndex)
            {
                display[i] = true;
            }
        }
        return display;
    }

    public record class StreetTileData
    {
        public string Title { get; init; } = string.Empty;
        public int? Color { get; init; }
        public int? Cost { get; init; }
        public int? HousingLevel { get; init; }
        public string? IconPath { get; init; }
        public bool MousePointer { get; init; } = false;
        public CardType? CardType { get; init; }
        public Imovel? Imovel { get; init; }
        public Companhia? Companhia { get; init; }
        public LinhaTrem? LinhaTrem { get; init; }
    }

    private void HandleMouseClickTile(StreetTileData tile)
    {
        if (tile.CardType != null)
        {
            switch (tile.CardType)
            {
                case CardType.TitleDeed:
                    if (tile.Imovel != null)
                    {
                        cardVisualizerStore.SetImovel(tile.Imovel);
                    }
                    break;
                case CardType.Company:
                    if (tile.Companhia != null)
                    {
                        cardVisualizerStore.SetCompanhia(tile.Companhia);
                    }
                    break;
                case CardType.TrainStation:
                    if (tile.LinhaTrem != null)
                    {
                        cardVisualizerStore.SetLinhaTrem(tile.LinhaTrem);
                    }
                    break;
            }
        }
        else
        {
        }
    }

    private StreetTileData GetStreetTileData(int tileIndex)
    {
        Piso piso = controlePartida.Partida.Tabuleiro.Pisos[tileIndex];

        if (piso is PisoCompravel pisoCompravel)
        {
            if (pisoCompravel.Propriedade is Imovel imovel)
            {
                return new() { Title = imovel.Nome, Color = (int)imovel.Cor, Cost = imovel.Preco, HousingLevel = 0, CardType = CardType.TitleDeed, Imovel = imovel, MousePointer = true };
            }
            if (pisoCompravel.Propriedade is Companhia companhia)
            {
                return new() { Title = companhia.Nome, Cost = companhia.Preco, CardType = CardType.Company, Companhia = companhia, MousePointer = true };
            }
            if (pisoCompravel.Propriedade is LinhaTrem linhaTrem)
            {
                return new() { Title = linhaTrem.Nome, Cost = linhaTrem.Preco, IconPath = "assets/icon/train-solid-full.svg", CardType = CardType.TrainStation, LinhaTrem = linhaTrem, MousePointer = true };
            }

            throw new Exception("Tipo de propriedade desconhecido.");
        }

        if (piso is PisoComprarCartaSorte)
        {
            return new() { Title = "Sorte ou Revés", IconPath = "assets/icon/question-solid-full.svg" };
        }

        if (piso is PisoComprarCartaCofre)
        {
            return new() { Title = "Baú Comunitário", IconPath = "assets/icon/gift-solid-full.svg" };
        }

        return new() { };
    }

    // private readonly List<StreetTileData> allStreetTiles = new()
    // {
    //     new() { Title = "Goomba Village", Color = "var(--color-1)", Cost = 60, HousingLevel = 1 },
    //     new() { Title = "Baú Comunitário", IconPath = "assets/icon/gift-solid-full.svg" },
    //     new() { Title = "Koopa Village", Color = "var(--color-1)", Cost = 60, HousingLevel = 2 },
    //     new() { Title = "Taxa de Riquesa", Cost = 200, IconPath = "assets/icon/gem-solid-full.svg" },
    //     new() { Title = "Toad Town Train Station", Cost = 200, IconPath = "assets/icon/train-solid-full.svg" },
    //     new() { Title = "Mt Rugged", Color = "var(--color-2)", Cost = 100, HousingLevel = 5 },
    //     new() { Title = "Sorte ou Revés", IconPath = "assets/icon/question-solid-full.svg" },
    //     new() { Title = "Dry Dry Outpost", Color = "var(--color-2)", Cost = 100, HousingLevel = 3 },
    //     new() { Title = "Dry Dry Ruins", Color = "var(--color-2)", Cost = 120 },

    //     new() { Title = "Boo's Mansion", Color = "var(--color-3)", Cost = 140 },
    //     new() { Title = "Big Lantern Ghost", Cost = 150 },
    //     new() { Title = "Gusty Gulch", Color = "var(--color-3)", Cost = 140 },
    //     new() { Title = "Tubba Blubba's Castle", Color = "var(--color-3)", Cost = 160 },
    //     new() { Title = "Toy Box Train", Cost = 200, IconPath = "assets/icon/train-solid-full.svg" },
    //     new() { Title = "Toad Town Tunnels", Color = "var(--color-4)", Cost = 180 },
    //     new() { Title = "Baú Comunitário", IconPath = "assets/icon/gift-solid-full.svg" },
    //     new() { Title = "Shooting Star Summit", Color = "var(--color-4)", Cost = 180 },
    //     new() { Title = "Shy Guy's Toybox", Color = "var(--color-4)", Cost = 200 },

    //     new() { Title = "Yoshi's Village", Color = "var(--color-5)", Cost = 220 },
    //     new() { Title = "Sorte ou Revés", IconPath = "assets/icon/question-solid-full.svg" },
    //     new() { Title = "Jade Jungle", Color = "var(--color-5)", Cost = 220 },
    //     new() { Title = "Mt Lavalava", Color = "var(--color-5)", Cost = 240 },
    //     new() { Title = "Star Crusier", Cost = 200, IconPath = "assets/icon/train-solid-full.svg" },
    //     new() { Title = "Flower Fields", Color = "var(--color-6)", Cost = 260 },
    //     new() { Title = "Sun Tower", Color = "var(--color-6)", Cost = 260 },
    //     new() { Title = "Paper Mario Whale", Cost = 150 },
    //     new() { Title = "Cloudy Climb", Color = "var(--color-6)", Cost = 280 },

    //     new() { Title = "Shiver City", Color = "var(--color-7)", Cost = 300 },
    //     new() { Title = "Starborn Valley", Color = "var(--color-7)", Cost = 300 },
    //     new() { Title = "Baú Comunitário", IconPath = "assets/icon/gift-solid-full.svg" },
    //     new() { Title = "Crystal Palace", Color = "var(--color-7)", Cost = 320 },
    //     new() { Title = "Trem", Cost = 200, IconPath = "assets/icon/train-solid-full.svg" },
    //     new() { Title = "Sorte ou Revés", IconPath = "assets/icon/question-solid-full.svg" },
    //     new() { Title = "Star Heaven", Color = "var(--color-8)", Cost = 350 },
    //     new() { Title = "Taxa de Riquesa", Cost = 100, IconPath = "assets/icon/gem-solid-full.svg" },
    //     new() { Title = "Bowser's Castle", Color = "var(--color-8)", Cost = 400 }
    // };
}
