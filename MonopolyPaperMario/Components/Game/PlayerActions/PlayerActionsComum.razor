@using MonopolyGame.Interface.Controles;
@using MonopolyGame.Interface.PosseJogador;
@using MonopolyGame.Model.PossesJogador;
@using MonopolyGame.Model.Leiloes;
@using MonopolyPaperMario.Components.Stores;


<button class="btn btn-primary mb-1 @(ControlePartida.ComandoDisponivel(ControlePartidaComando.Comum_RolarDados) ? "" : "disabled")"
          @onclick=HandleRolarDados
          >
    Rolar Dados
</button>

<button class="btn btn-primary mb-1 @(ControlePartida.ComandoDisponivel(ControlePartidaComando.Comum_IniciarPropostaTroca) ? "" : "disabled")"
    @onclick=HandleIniciarPropostaTroca>
    Criar Proposta de Troca
</button>

<div class="mb-1">
    <div class="dropdown">
        <button type="button" class="w-100 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            Criar Leilão
        </button>
        <form class="w-100 dropdown-menu p-2">
            <div class="mb-2">
                <label for="selectPropriedade" class="form-label">Selecione uma Propriedade</label>

                <select class="form-select" @onchange=HandlePosseLeilaoChange>
                    <option value=null selected disabled>Escolha uma propriedade</option>

                    @foreach (var imovel in ControlePartida.Partida.JogadorAtual.Posses)
                    {
                        <option value="@imovel.Nome">@imovel.Nome</option>
                    }
                </select>
            </div>

            <button class="btn btn-primary @(posseLeilao == null ? "disabled" : "")" @onclick=HandleComecarLeilao>Começar Leilão</button>
        </form>
    </div>
</div>

@if (ControlePartida.ComandoDisponivel(ControlePartidaComando.Comum_MelhorarImovel))
{
    @* MELHORAR PROPRIEDADE *@
    <div class="mb-1">
        <div class="dropdown">
            <button type="button" class="w-100 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                Comprar Casa(não implementado)
            </button>
            <form class="w-100 dropdown-menu p-2">
                <div class="mb-2">
                    <label for="selectPropriedade" class="form-label">Selecione uma Propriedade</label>

                    <select class="form-select" id="selectPropriedade" aria-label="Seleção de Propriedade">
                        <option selected disabled>Escolha uma propriedade</option>

                        @foreach (var imovel in ControlePartida.Partida.JogadorAtual.Posses.OfType<Imovel>())
                        {
                            <option value="@imovel">@imovel.Nome</option>
                        }
                    </select>
                </div>

                <button class="btn btn-primary">Comprar Casa</button>
            </form>
        </div>
    </div>
}
@if (ControlePartida.ComandoDisponivel(ControlePartidaComando.Comum_DepreciarImovel))
{
    @* DEPRECIAR PROPRIEDADE *@
    <div class="mb-1">
        <div class="dropdown">
            <button type="button" class="w-100 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                Vender Casa(não implementado)
            </button>
            <form class="w-100 dropdown-menu p-2">
                <div class="mb-2">
                    <label for="selectPropriedade" class="form-label">Selecione uma Propriedade</label>

                    <select class="form-select" id="selectPropriedade" aria-label="Seleção de Propriedade">
                        <option selected disabled>Escolha uma propriedade</option>

                        @foreach (var imovel in ControlePartida.Partida.JogadorAtual.Posses.OfType<Imovel>())
                        {
                            <option value="@imovel">@imovel.Nome</option>
                        }
                    </select>
                </div>

                <button class="btn btn-primary">Vender Casa</button>
            </form>
        </div>
    </div>
}
@if (ControlePartida.ComandoDisponivel(ControlePartidaComando.Comum_HipotecarPropriedade))
{
    @* HIPOTECAR PROPRIEDADE *@
    <div class="mb-1">
        <div class="dropdown">
            <button type="button" class="w-100 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                Hipotecar Propriedade(não implementado)
            </button>
            <form class="w-100 dropdown-menu p-2">
                <div class="mb-2">
                    <label for="selectPropriedade" class="form-label">Selecione uma Propriedade</label>

                    <select class="form-select" id="selectPropriedade" aria-label="Seleção de Propriedade">
                        <option selected disabled>Escolha uma propriedade</option>

                        @foreach (var imovel in ControlePartida.Partida.JogadorAtual.Posses.OfType<Propriedade>())
                        {
                            <option value="@imovel">@imovel.Nome</option>
                        }
                    </select>
                </div>

                <button class="btn btn-primary">Hipotecar Propriedade</button>
            </form>
        </div>
    </div>
}

<button class="btn btn-primary mb-2 @(ControlePartida.ComandoDisponivel(ControlePartidaComando.Comum_EncerrarTurno) ? "" : "disabled")"
    @onclick=HandleEncerrarTurno>
    Encerrar Turno
</button>

<ModalPropostaTroca IsVisible="@_showTradeModal" OnClose="@(() => _showTradeModal = false)" />


@code {
    private IControlePartida ControlePartida = ControlePartidaStore.ControlePartida;

    // NOVO CAMPO para controlar a visibilidade do modal
    private bool _showTradeModal = false;

    private IPosseJogador? posseLeilao;

    protected override void OnInitialized()
    {
        ControlePartidaStore.OnStateChanged += StateHasChanged;
    }

    private void HandleRolarDados()
    {
        ControlePartida.Comum_RolarDados();
        ControlePartidaStore.NotifyStateChanged();
    }

    private void HandleIniciarPropostaTroca()
    {
        _showTradeModal = true;
    }

    private void HandlePosseLeilaoChange(ChangeEventArgs e)
    {
        var posseLeilaoNome = e.Value?.ToString();

        if (string.IsNullOrEmpty(posseLeilaoNome))
        {
            posseLeilao = null;
        }
        else
        {
            posseLeilao = ControlePartida.Partida.JogadorAtual.Posses.First(posse => posse.Nome == posseLeilaoNome);
        }
    }

    private void HandleComecarLeilao()
    {
        if (posseLeilao == null) return;
        ControlePartida.Leilao_Iniciar(new Leilao(ControlePartida.Partida.JogadorAtual, posseLeilao));
        ControlePartidaStore.NotifyStateChanged();
    }

    private void HandleEncerrarTurno()
    {
        ControlePartida.Comum_EncerrarTurno();
        ControlePartidaStore.NotifyStateChanged();
    }

    private void HandleMelhorarImovel()
    {
        ControlePartidaStore.NotifyStateChanged();
    }

    private void HandleDepreciarImovel()
    {
        ControlePartidaStore.NotifyStateChanged();
    }

    private void HandleHipotecarPropriedade()
    {
        ControlePartidaStore.NotifyStateChanged();
    }
}
